---
output:
  html_document: default
  pdf_document: default
---

# Data {#data}

```{r dat, include=FALSE}
library(dplyr)
library(knitr)
library(ggplot2)
library(grid)
library(png)
knitr::opts_chunk$set(warning = FALSE, message=FALSE, echo=FALSE)

load("../rdatafiles/Xtot.RData")
kab <- Xtot %>%
  '['(700:704,) %>%
  mutate(gameid=as.character(gameid),
         time = as.character(time)) %>%
  select(season, gameid, time, globalplayerid, r, theta, home, result)

kabsum <- matrix(nrow=3, ncol=ncol(kab))
colnames(kabsum) <- colnames(kab)
rownames(kabsum) <- c("Type", "Values", "Extra Details")
kabsum[,"season"] <- c("categorical", "{2014, ..., 2017}", "")
kabsum[,"gameid"] <- c("categorical", "NA", "94 unique values")
kabsum[,"time"] <- c("continuous", "NA", "13-digit timestamp in milliseconds")
kabsum[,"globalplayerid"] <- c("categorical", "NA", "31 unique values")
kabsum[,"r"] <- c("continuous", "[0, $\\infty$)", "Distance of shot from hoop (feet)")
kabsum[,"theta"] <- c("continuous", "[-$\\pi$, $\\pi$]", "Angle of shot (radians)")
kabsum[,"home"] <- c("categorical", "{0,1}", "1 if shot occured during a home game, 0 otherwise")
kabsum[,"result"] <- c("categorical", "{0,1}", "1 if shot was made, 0 if shot was missed (response)")

```

(This figure only contains shots that occur in front of the half-court line).
Theta has a range of $2\pi$ radians, but this plot shows that most of the attempts occured within the interval (-$\frac{\pi}{2}$, $\frac{\pi}{2}$). This figure also shows the bimodal distribution of shot distance over all players.


## Description of Dataset

The data for this analysis comes from SportVU, a player-tracking system from STATS, LLC. that provides precise coordinates for all ten players and the ball at a rate of 25 times per second. The Duke University Men's Basketball team permitted us to use their SportVU data from the 2014 to 2017 basketball seasons for this project. Since the ability to record this data depends on specialized tracking cameras, Duke does not have this data for every game they play---only home games, and a few road games in arenas that had the techology installed. Therefore, there is a substantial amount of missing data between games.

For our analysis, we use the following files for each game:

* Final Sequence Play-by-Play Optical:

This dataset comes in an a semi-structured Extensible Markup Language (XML) file, where there is a unique element for each "event" (an event is a basketball action such as a dribble, pass, shot, foul, etc.). Each event element has attributes describing the type of event, the time of the event, and the player who completed the action. We use these files to uncover when a shot is attempted in a game, who attempted the shot, and the result of the shot attempt.
    
* Box Score Optical:

We use this dataset to match the names and IDs of players who are in the game. This is also an XML file, with elements corresponding to individual players. These elements contain attributes describing information about the player (e.g. team name, jersey number) and various statistics for the game (e.g. points, assists, distance run).

* Final Sequence Optical:

    These XML files contain the locations of all ten players and the ball during precise time intervals within the game. Each timeunit has a unique element, and these elements have attributes describing the locations. We merge this with the Final Sequence Play-by-Play Optical data on the time attribute to obtain the shooter's location at the moment of a shot attempt.

## Data Cleaning

  Steps taken to clean the merged shooter IDs with shot locations include standardizing the locations onto a half-court setting (the teams switch sides of the court halfway through every game, which means that we have to flip the coordinates across the middle of the court for half of the data in every game), converting the x-y coordinates to polar coordinates (in the units of feet and radians), and including an indicator for home games. The final dataset had `r nrow(Xtot)` observations from `r n_distinct(Xtot$globalplayerid)` shooters over `r n_distinct(Xtot$gameid)` games. A summary of the cleaned dataset, and an excerpt:
    

```{r disp, include=TRUE}

kable(t(kabsum))
kable(kab)

img.path <- "./figure/ncaa_bball_court2.png"
img <- readPNG(img.path)

xrange <- c(-25,25)
yrange <- c(0,94/2) - 4
Xtotrange <- Xtot %>%
  filter(yt > yrange[1] & yt < yrange[2] & xt > xrange[1] & xt < xrange[2])

plt <- ggplot(Xtotrange, aes(x=xt, y=yt, color=as.factor(result))) + 
  annotation_custom(rasterGrob(img,
                               x=0.50, y=0.50,
                               width = .92, height = .92),
                    -Inf, Inf, -Inf, Inf) + 
  scale_color_manual(values=c("red", "blue")) +
  geom_point(alpha=0.2) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_label(data = data.frame(c(NA, NA, NA)),
           x=c(-13, 3, 13), 
           y=c(-1, 40, -1), 
           parse=TRUE,
           label=c(as.character(expression(theta == frac(pi,2))),
                   as.character(expression(theta == 0)),
                   as.character(expression(theta == -frac(pi,2)))),
           size=3,
           color="black", 
           fontface="bold") +
  labs(title = "Distribution of Shot Locations", y="", x="", color = "result") +
  theme_bw() + 
  theme(panel.grid = element_blank(), panel.border = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())

plt
```


## Exploratory Data Analysis

The following exploratory plots examine how consistent the probability of a made shot is, using a loess smooth curve on the binary outcomes. We present these smoothed plots for four high-usage basketball players at Duke University between the 2013-2014 and 2016-2017 seasons, and we leave the others in Appendix *number*. Each plot represents a single player's ordered shooting outcomes for a single season. These plots do not account for the amount of time in between shots, but simply shot order and outcome. 

```{r load}
load(file="../rdatafiles/Xtot.RData")

id1 <- 887665 
id2 <- 842301 
id3 <- 603106 
id4 <- 842296 
playerseasons <- matrix(
  c(id1,   2016,
    id2,   2015,
    id3,   2014,
    id4,   2016
  ),ncol=2,byrow = TRUE
)
colnames(playerseasons) <- c("globalplayerid" ,"season")
```

```{r, plots}

plotshottime <- function(playerid, season, playernum){
  Xtot_sub <- Xtot[Xtot$globalplayerid==playerid & Xtot$season==season,]
  par(las=1)
  if(nrow(Xtot_sub) < 10){
    # ggplot(data=NULL) + labs(title = "Not Enough Data") + theme_bw()
    plot(0,0,type="n", yaxt="n",xaxt="n", ylab="",xlab="")
    text(0,0,label="Not Enough Data", cex=2)
  }else{
    Y <- Xtot_sub$result #zoo::rollmean((Xtot_sub$result), 4)
    X <- 1:length(Y)
    scatter.smooth(X,Y,span=20/length(Y), main = paste0("Smoothed Shooting Outcomes: Player ",playernum),
                   yaxt="n",ylab="Result",xlab="Order")
    axis(side=2,at=c(0,1),labels=c("Miss","Make"))
  }
}

maxseason <- Xtot %>% group_by(globalplayerid, season) %>% summarize(num=n()) %>% group_by(globalplayerid) %>% mutate(m=max(num)) %>% filter(num==m) %>% as.data.frame()

par(mfrow = c(2,2))
for(i in 1:nrow(playerseasons)){
  r <- playerseasons[i,]
  plotshottime(r[[1]],r[[2]],i)
}
```

We can see that the plots vary in the consistency of their made shots, since they all contain spikes and trends. For example, the third plot initially has a very high success rate, which quickly falls to the middle after about thirty shot attempts, and the second plot has a noticeable upward trend in shot success beginning around shot number one hundred fifty.

We investigate the shooting outcomes using Bayesian models, and present the results in the next section.
