<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>My Final College Paper</title>
  <meta name="description" content="My Final College Paper">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="My Final College Paper" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="My Final College Paper" />
  
  
  

<meta name="author" content="Nathaniel Brown">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="3-proc.html">
<link rel="next" href="references.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"></a></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="1-abstract.html"><a href="1-abstract.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="2-litreview.html"><a href="2-litreview.html"><i class="fa fa-check"></i><b>2</b> Literature Review</a></li>
<li class="chapter" data-level="3" data-path="3-proc.html"><a href="3-proc.html"><i class="fa fa-check"></i><b>3</b> Procedure</a></li>
<li class="chapter" data-level="4" data-path="4-sim.html"><a href="4-sim.html"><i class="fa fa-check"></i><b>4</b> DGLM On Simulated Data</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">My Final College Paper</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sim" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> DGLM On Simulated Data</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#things I&#39;m having trouble with:</span>
  <span class="co">#positive definite sCt[,,t]</span>
  <span class="co">#interpretation</span>
  <span class="co">#confidence interval plot</span>

<span class="kw">library</span>(mvtnorm)
<span class="kw">set.seed</span>(<span class="dv">3</span>)
<span class="co">#court dimensions</span>
xm &lt;-<span class="st"> </span><span class="dv">50</span>; ym &lt;-<span class="st"> </span><span class="dv">94</span>            
<span class="co">#num time units within a game</span>
T &lt;-<span class="st"> </span><span class="dv">48</span>/<span class="fl">0.25</span>                 

<span class="co">#generating shot attempts with constant prob over the course of a game</span>
prshot &lt;-<span class="st"> </span><span class="fl">0.4</span>
<span class="co">#shots is binary shot attempt vector</span>
shots &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dt">n=</span>T) &lt;<span class="st"> </span>prshot  
tshot &lt;-<span class="st"> </span><span class="kw">which</span>(shots)
nshots &lt;-<span class="st"> </span><span class="kw">length</span>(tshot)

<span class="co">#x-y coordinates in feet. origin = basket</span>
x &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(xm*(<span class="dv">2</span>*<span class="kw">rbeta</span>(<span class="dt">n=</span>nshots, <span class="dv">6</span>,<span class="dv">8</span>) -<span class="st"> </span><span class="dv">1</span>),
              ym*<span class="kw">rbeta</span>(<span class="dt">n=</span>nshots, <span class="dv">2</span>, <span class="dv">12</span>)), 
            <span class="dt">ncol =</span> <span class="dv">2</span>)
<span class="kw">plot</span>(x, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,ym), <span class="dt">xlim=</span><span class="kw">c</span>(-xm,xm))
<span class="kw">abline</span>(<span class="dt">h=</span>ym/<span class="dv">2</span>)
<span class="kw">points</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">cex=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="thesis_files/figure-html/everything-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#convert to theta and r</span>
z &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">atan</span>(x[,<span class="dv">2</span>]/x[,<span class="dv">1</span>]),
            <span class="kw">sqrt</span>(<span class="kw">rowSums</span>(x^<span class="dv">2</span>))),
            <span class="dt">ncol=</span><span class="dv">2</span>)
<span class="co">#a shifting factor to roughly center log(r) around 0</span>
za &lt;-<span class="st"> </span><span class="kw">log</span>(ym/<span class="dv">5</span>)
<span class="co">#2 covariates and intercept</span>
Z &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dv">1</span>, z[,<span class="dv">1</span>], <span class="kw">log</span>(z[,<span class="dv">2</span>]) -<span class="st"> </span>za)
<span class="kw">plot</span>(Z[,<span class="dv">2</span>], Z[,<span class="dv">3</span>]+za, <span class="dt">xlab =</span> <span class="st">&quot;angle&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;log distance&quot;</span>)</code></pre></div>
<p><img src="thesis_files/figure-html/everything-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#generating shot success probabilities</span>
theta &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(-<span class="fl">0.5</span>, <span class="fl">1.5</span>, -<span class="fl">5.5</span>)) <span class="co">#GLM parameters</span>
p &lt;-<span class="st"> </span><span class="kw">length</span>(theta)
pscore &lt;-<span class="st"> </span><span class="dv">1</span>/(<span class="dv">1</span>+<span class="kw">exp</span>(-Z %*%<span class="st"> </span>theta))
q &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NaN</span>, T)
q[shots] &lt;-<span class="st"> </span>pscore

<span class="co">#generating shot outcomes</span>
y &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NaN</span>, T)
y[shots] &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dt">n=</span>nshots) &lt;=<span class="st"> </span>pscore
iy &lt;-<span class="st"> </span><span class="kw">which</span>(y[!<span class="kw">is.nan</span>(y)] ==<span class="st"> </span><span class="dv">1</span>)
<span class="kw">par</span>(<span class="dt">xpd=</span><span class="ot">TRUE</span>)
<span class="kw">plot</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">type=</span><span class="st">&quot;n&quot;</span>,<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,T),<span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="dt">ylab =</span> <span class="st">&quot;probability&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;time interval&quot;</span>, <span class="dt">main =</span> <span class="st">&quot;GLM&quot;</span>)
<span class="kw">points</span>(tshot, q[tshot], <span class="dt">pch=</span><span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)
<span class="kw">points</span>(tshot, y[tshot], <span class="dt">pch=</span><span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)
<span class="kw">legend</span>(<span class="dt">x=</span>T*<span class="fl">0.75</span>, <span class="dt">y=</span><span class="fl">1.21</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;probability&quot;</span>, <span class="st">&quot;outcome&quot;</span>), <span class="dt">pch =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">1</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>))</code></pre></div>
<p><img src="thesis_files/figure-html/everything-3.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(x[iy,], <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,ym), <span class="dt">xlim=</span><span class="kw">c</span>(-xm,xm), <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">pch =</span> <span class="dv">3</span>)
<span class="kw">points</span>(x[-iy,], <span class="dt">col =</span><span class="st">&quot;blue&quot;</span>, <span class="dt">pch =</span> <span class="dv">1</span>)
<span class="kw">points</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">cex=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="thesis_files/figure-html/everything-4.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#set up DGLM and initial prior</span>
<span class="co">#first, set up covariates per time interval</span>
F &lt;-<span class="st"> </span><span class="kw">t</span>(Z)
p &lt;-<span class="st"> </span><span class="kw">dim</span>(F)[<span class="dv">1</span>]
mt &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,p) <span class="co">#prior mean vector</span>
Ct &lt;-<span class="st"> </span><span class="kw">diag</span>(p) <span class="co">#prior covariance matrix</span>
delta &lt;-<span class="st"> </span><span class="fl">0.99</span> <span class="co">#discount factor; &quot;streaky parameter&quot;</span>
<span class="co">#forward filtering (FF)</span>
smt &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="dv">0</span>,p*T), <span class="dt">nrow=</span>p)           <span class="co">#save post means</span>
sCt &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="kw">rep</span>(<span class="dv">0</span>,p*p*T), <span class="dt">dim =</span> <span class="kw">c</span>(p,p,T))  <span class="co">#save post covars</span>
spt &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NaN</span>, T)                          <span class="co">#save post prob success</span>
lmlik &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>,T)                           <span class="co">#marg lik per time int</span>
ishot &lt;-<span class="st"> </span><span class="dv">0</span>
for(t in <span class="dv">1</span>:T){
  if(t %in%<span class="st"> </span>tshot){
    <span class="co">#current shot attempt index, and time</span>
    ishot &lt;-<span class="st"> </span>ishot +<span class="st"> </span><span class="dv">1</span>
    ti &lt;-<span class="st"> </span>tshot[ishot]
    
    ft &lt;-<span class="st"> </span>(F[,ishot]) %*%<span class="st"> </span>mt
    At &lt;-<span class="st"> </span>Ct %*%<span class="st"> </span>F[,ishot]/delta
    qt &lt;-<span class="st"> </span>(F[,ishot]) %*%<span class="st"> </span>At
    At &lt;-<span class="st"> </span>At/<span class="kw">as.numeric</span>(qt)
    
    <span class="co">#prior mean and var of linear predictor, and adaptive vector</span>
    <span class="co">#compute approx prior Beta(r,s) params; update w/ numerical iterations for exact values</span>
    eft &lt;-<span class="st"> </span><span class="kw">exp</span>(ft)   <span class="co">#crude initial values</span>
    rt &lt;-<span class="st"> </span>(<span class="dv">1</span>+eft)/qt
    st &lt;-<span class="st"> </span>rt/eft
    rt &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="fl">0.5</span>, rt)
    st &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="fl">0.5</span>, st)
    
    <span class="co">#iterative numerical solution</span>
    ep &lt;-<span class="st"> </span><span class="fl">0.5</span>; drt &lt;-<span class="st"> </span><span class="dv">1</span>; dst &lt;-<span class="st"> </span><span class="dv">1</span>; xt &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(rt, st))
    while(<span class="kw">max</span>(drt, dst) &lt;<span class="st"> </span>ep){
      r0t &lt;-<span class="st"> </span><span class="kw">psigamma</span>(rt,<span class="dv">0</span>); s0t &lt;-<span class="st"> </span><span class="kw">psigamma</span>(st,<span class="dv">0</span>)
      r1t &lt;-<span class="st"> </span><span class="kw">psigamma</span>(rt,<span class="dv">1</span>); s1t &lt;-<span class="st"> </span><span class="kw">psigamma</span>(st,<span class="dv">1</span>)
      fxt &lt;-<span class="st"> </span><span class="kw">c</span>(r0t-s0t-ft, r1t+s1t-qt)
      Axt &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(r1t, -s1t, <span class="kw">psigamma</span>(rt, <span class="dv">2</span>), <span class="kw">psigamma</span>(st, <span class="dv">2</span>)), <span class="dt">ncol=</span><span class="dv">2</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)
      xt &lt;-<span class="st"> </span>xt -<span class="st"> </span><span class="kw">solve</span>(Axt, fxt)
      drt &lt;-<span class="st"> </span>xt[<span class="dv">1</span>] -<span class="st"> </span>rt; dst &lt;-<span class="st"> </span>xt[<span class="dv">2</span>] -<span class="st"> </span>st
      rt &lt;-<span class="st"> </span>xt[<span class="dv">1</span>]; st &lt;-<span class="st"> </span>xt[<span class="dv">2</span>]
    }
    lmlik[t] &lt;-<span class="st"> </span><span class="kw">lgamma</span>(rt+st) -<span class="st"> </span><span class="kw">lgamma</span>(rt) -<span class="st"> </span><span class="kw">lgamma</span>(st) +<span class="st"> </span>
<span class="st">                </span><span class="kw">lgamma</span>(rt+y[t]) +<span class="st"> </span><span class="kw">lgamma</span>(st<span class="dv">+1</span>-y[t]) -<span class="st"> </span><span class="kw">lgamma</span>(rt+st<span class="dv">+1</span>) +<span class="st"> </span>
<span class="st">                </span><span class="kw">lgamma</span>(<span class="dv">2</span>) -<span class="st"> </span><span class="kw">lgamma</span>(<span class="dv">1</span>+y[t]) -<span class="st"> </span><span class="kw">lgamma</span>(<span class="dv">2</span>-y[t])
    rts &lt;-<span class="st"> </span>rt +<span class="st"> </span>y[t]; sts &lt;-<span class="st"> </span>st +<span class="st"> </span><span class="dv">1</span>-y[t] <span class="co">#posterior beta params</span>
    <span class="co">#convert to mean and variance for linear predictor</span>
    fts &lt;-<span class="st"> </span><span class="kw">psigamma</span>(rts,<span class="dv">0</span>)-<span class="kw">psigamma</span>(sts,<span class="dv">0</span>); qts &lt;-<span class="st"> </span><span class="kw">psigamma</span>(rts,<span class="dv">1</span>)+<span class="kw">psigamma</span>(sts,<span class="dv">0</span>)
    spt[t] &lt;-<span class="st"> </span>rts/(sts+rts)
    
    <span class="co">#update state parameters</span>
    mt &lt;-<span class="st"> </span>mt+At%*%(fts-ft)
    Ct &lt;-<span class="st"> </span>Ct/delta -<span class="st"> </span>(At%*%<span class="kw">t</span>(At))*<span class="kw">as.numeric</span>(qt-qts)
    Ct &lt;-<span class="st"> </span>(Ct +<span class="st"> </span><span class="kw">t</span>(Ct))/<span class="dv">2</span>
    <span class="kw">c</span>(t, rt, st, mt)
    
    if(<span class="kw">any</span>(<span class="kw">is.nan</span>(mt))){
      <span class="kw">print</span>(<span class="st">&quot;stop&quot;</span>)
      break
    }
  }
  smt[,t] &lt;-<span class="st"> </span>mt; sCt[,,t] &lt;-<span class="st"> </span>Ct <span class="co">#saving</span>
}

<span class="co">#THIS IS NOT RIGHT. YELLOW IS TOO WONKY</span>
<span class="kw">plot</span>(smt[<span class="dv">1</span>,],<span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(-<span class="dv">20</span>, <span class="dv">20</span>), <span class="dt">xlab =</span> <span class="st">&quot;time interval&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;online state mean&quot;</span>)
<span class="kw">lines</span>(smt[<span class="dv">2</span>,],<span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;orange&quot;</span>)
<span class="kw">lines</span>(smt[<span class="dv">3</span>,],<span class="dt">type=</span><span class="st">&quot;l&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;yellow&quot;</span>)</code></pre></div>
<p><img src="thesis_files/figure-html/everything-5.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">xpd=</span><span class="ot">TRUE</span>)
<span class="kw">plot</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">type=</span><span class="st">&quot;n&quot;</span>,<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,T),<span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="dt">ylab =</span> <span class="st">&quot;probability&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;time interval&quot;</span>, <span class="dt">main =</span> <span class="st">&quot;GLM&quot;</span>)
<span class="kw">points</span>(tshot, spt[tshot], <span class="dt">pch=</span><span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)
<span class="kw">points</span>(tshot, y[tshot], <span class="dt">pch=</span><span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)
<span class="kw">legend</span>(<span class="dt">x=</span>T*<span class="fl">0.75</span>, <span class="dt">y=</span><span class="fl">1.21</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;probability&quot;</span>, <span class="st">&quot;outcome&quot;</span>), <span class="dt">pch =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">1</span>), <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>))</code></pre></div>
<p><img src="thesis_files/figure-html/everything-6.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Backward sampling</span>
nmc &lt;-<span class="st"> </span><span class="dv">1000</span>
<span class="co">#save posterior means and posterior success probs</span>
MCtheta &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="kw">c</span>(p, T, nmc)) 
MCq &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="kw">c</span>(T, nmc))

<span class="co">#begin BS at timeunit T</span>
thetat &lt;-<span class="st"> </span><span class="kw">rmvnorm</span>(<span class="dt">n=</span>nmc, smt[,T], sCt[,,T])
MCtheta[,T,] &lt;-<span class="st"> </span><span class="kw">t</span>(thetat)
MCq[T,] &lt;-<span class="st"> </span><span class="dv">1</span>/(<span class="dv">1</span>+<span class="kw">exp</span>(-thetat %*%<span class="st"> </span>F[,nshots]))

<span class="co">#then recurse backwards</span>
ishot &lt;-<span class="st"> </span>nshots +<span class="st"> </span><span class="dv">1</span>
for(t in (T<span class="dv">-1</span>):<span class="dv">1</span>){
  if(t %in%<span class="st"> </span>tshot){
    ht =<span class="st"> </span>(<span class="dv">1</span>-delta)*<span class="kw">t</span>(<span class="kw">array</span>(smt[,<span class="dv">7</span>], <span class="kw">c</span>(<span class="kw">dim</span>(smt)[<span class="dv">1</span>], nmc))) +<span class="st"> </span>delta*thetat
    <span class="co">#run a simulation for each row of ht and each 3rd dim of sCt</span>
    thetat &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">apply</span>(ht, <span class="dv">1</span>, rmvnorm, <span class="dt">n=</span><span class="dv">1</span>, <span class="dt">sigma =</span> sCt[,,t]*(<span class="dv">1</span>-delta)))
    MCtheta[,t,] &lt;-<span class="st"> </span><span class="kw">t</span>(thetat)
    ishot &lt;-<span class="st"> </span>ishot -<span class="st"> </span><span class="dv">1</span>; ti &lt;-<span class="st"> </span>tshot[ishot]
    MCq[t,] &lt;-<span class="st"> </span><span class="dv">1</span>/(<span class="dv">1</span>+<span class="kw">exp</span>(-thetat %*%<span class="st"> </span>F[,ishot]))
  }
}

<span class="co">#retrospective posterior summaries</span>
pr &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">apply</span>(MCq[tshot,], <span class="dv">1</span>, quantile, <span class="kw">c</span>(.<span class="dv">025</span>, .<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>, .<span class="dv">975</span>), <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) <span class="co">#get quantiles of each row</span>
<span class="co">#plot() #I can&#39;t do ciplot...</span>

<span class="co"># for(j in 1:p){</span>
<span class="co"># </span>
<span class="co"># }</span></code></pre></div>

<!--
The bib chunk below must go last in this document according to how R Markdown renders.  More info is at http://rmarkdown.rstudio.com/authoring_bibliographies_and_citations.html
-->
<p></p>
<!-- 
If you'd like to change the name of the bibliography to something else,
delete "References" and replace it.
-->
</div>
            </section>

          </div>
        </div>
      </div>
<a href="3-proc.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": [["thesis.pdf", "PDF"], ["thesis.epub", "EPUB"], ["thesis.docx", "Word"]],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
